{% extends 'core/base.html' %}
{% load static %}

{% block title %}Historial de Diagn√≥sticos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/css/dashboard.css' %}">
<style>
  .search-wrapper { padding: 2rem 1rem; }
  .search-container { max-width: 1000px; margin: 0 auto; }
  .search-header {
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .search-header h1 {
    color: #e2e8f0;
    font-size: 1.75rem;
    display: flex;
    gap: 0.6rem;
    align-items: center;
    margin: 0;
  }
  .btn-back {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.25rem;
    background: rgba(100, 116, 139, 0.2);
    border: 1px solid rgba(100, 116, 139, 0.4);
    border-radius: 8px;
    color: #94a3b8;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
  }
  .btn-back:hover {
    background: rgba(100, 116, 139, 0.3);
    color: #cbd5e1;
    border-color: rgba(100, 116, 139, 0.6);
  }
  .search-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }
  .search-form {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
  }
  .search-form-group {
    flex: 1;
  }
  .search-form label {
    color: #cbd5e1;
    font-weight: 600;
    display: block;
    margin-bottom: 0.5rem;
  }
  .search-input {
    width: 100%;
    padding: 0.875rem 1.25rem;
    background: rgba(15, 23, 42, 0.6);
    border: 2px solid rgba(100, 116, 139, 0.3);
    border-radius: 8px;
    color: #e2e8f0;
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  .search-input:focus {
    outline: none;
    background: rgba(15, 23, 42, 0.8);
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .search-input::placeholder {
    color: #64748b;
  }
  .search-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    border: none;
    border-radius: 8px;
    color: #ffffff;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
  }
  .search-button:hover {
    background: linear-gradient(135deg, #1e40af, #1e3a8a);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }
  .search-button:active {
    transform: translateY(0);
  }
</style>
{% endblock %}

{% block content %}
<div class="search-wrapper">
  <div class="search-container">
    <div class="search-header">
      <h1>
        <span>üìã</span>
        <span>Historial de Diagn√≥sticos</span>
      </h1>
      <a href="{% url 'users:user_dashboard' %}" class="btn-back">‚Üê Volver al Dashboard</a>
    </div>

    <div class="search-card">
      <form method="get" class="search-form">
        <div class="search-form-group">
          <label for="search_input">Criterio de b√∫squeda</label>
          <input 
            type="text" 
            id="search_input" 
            name="q" 
            class="search-input" 
            placeholder="Ingresa nombre o n√∫mero de documento..." 
            value="{{ query }}"
            autofocus
          >
        </div>
        <button type="submit" class="search-button">
          <span>üîé</span>
          <span>Buscar</span>
        </button>
      </form>
    </div>

    {% if patients %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Resultados ({{ patients.count }})</h5>
        <ul class="list-group list-group-flush">
        {% for p in patients %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ p.get_full_name }}</strong> - {{ p.identification }}<br>
              <small>{{ p.get_age }} a√±os ‚Ä¢ {{ p.get_gender_display_spanish }}</small>
            </div>
            <div>
              <a href="?patient_id={{ p.id }}" class="btn btn-outline-primary">Ver Historial</a>
            </div>
          </li>
        {% endfor %}
        </ul>
      </div>
    </div>
    {% elif query %}
      <div class="alert alert-info">No se encontraron pacientes.</div>
    {% endif %}

    {% if patient %}
    <div class="card">
      <div class="card-body">
        <h3>Paciente: {{ patient.get_full_name }} <small class="text-muted">({{ patient.identification }})</small></h3>
        <p><strong>Edad:</strong> {{ patient.get_age }} a√±os ‚Ä¢ <strong>G√©nero:</strong> {{ patient.get_gender_display_spanish }}</p>

        {% if diagnoses %}
          <h4 class="mt-3">Diagn√≥sticos ({{ diagnoses.count }})</h4>
          <ul class="list-group">
            {% for d in diagnoses %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <strong>Diagn√≥stico #{{ d.id }}</strong> - <span class="badge badge-secondary">{{ d.get_status_display }}</span><br>
                <small>{{ d.created_at|date:'d/m/Y H:i' }} ‚Ä¢ Confianza: {{ d.confidence_level|default:'-' }}%</small>
                <p class="mb-0">{{ d.diagnosis_result|truncatechars:160 }}</p>
              </div>
              <div>
                <a href="{% url 'diagnostico:diagnosis_detail' diagnosis_id=d.id %}" class="btn btn-sm btn-primary">Ver detalles</a>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="alert alert-warning">No existen diagn√≥sticos registrados para este paciente.</div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'users/js/dashboard.js' %}"></script>
{% endblock %}

