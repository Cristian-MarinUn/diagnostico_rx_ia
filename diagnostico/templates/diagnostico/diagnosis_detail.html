{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'diagnostico/css/diagnosis_detail.css' %}">
{% endblock %}

{% block content %}
<div class="diagnosis-detail-container" data-diagnosis-id="{{ diagnosis.id }}">
    <div style="margin-bottom:1.5rem;">
        <a href="{% url 'users:diagnosis_history' %}?patient_id={{ diagnosis.patient.id }}" class="btn-back" style="text-decoration:none;display:inline-flex;align-items:center;gap:0.5rem;padding:0.875rem 1.25rem;background:rgba(100,116,139,0.2);border:1px solid rgba(100,116,139,0.4);border-radius:8px;color:#94a3b8;font-weight:600;cursor:pointer;transition:all 0.3s ease;">
            ‚Üê Volver al Historial
        </a>
    </div>
    <!-- Status Header -->
    <div class="status-header">
        <div class="status-row">
            <div class="status-info">
                <div class="diagnosis-id">ID: {{ diagnosis.id }}</div>
                <h1 class="diagnosis-title">
                    Diagn√≥stico para 
                    <a href="#" class="patient-link">
                        {{ diagnosis.patient.get_full_name }}
                    </a>
                </h1>
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <span class="status-badge-large status-{{ diagnosis.status|lower }}">
                        {% if diagnosis.status == 'PENDING' %}‚è≥
                        {% elif diagnosis.status == 'PROCESSING' %}‚öôÔ∏è
                        {% elif diagnosis.status == 'COMPLETED' %}‚úÖ
                        {% elif diagnosis.status == 'FAILED' %}‚ùå
                        {% elif diagnosis.status == 'VALIDATED' %}‚úì
                        {% elif diagnosis.status == 'DISCARDED' %}üóëÔ∏è
                        {% endif %}
                        {{ diagnosis.get_status_display }}
                    </span>
                    
                    {% if diagnosis.created_at %}
                    <span style="color: var(--text-secondary); font-size: 0.875rem;">
                        üìÖ {{ diagnosis.created_at|date:"d/m/Y H:i" }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Progress Bar for Processing Status -->
        {% if diagnosis.status == 'PROCESSING' or diagnosis.status == 'PENDING' %}
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" style="width: {% if diagnosis.status == 'PENDING' %}25%{% else %}75%{% endif %}"></div>
            </div>
            <div class="progress-text">
                {% if diagnosis.status == 'PENDING' %}
                    ‚è≥ En cola para procesamiento...
                {% else %}
                    ‚öôÔ∏è Procesando con motor de IA...
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Main Content Grid -->
    <div class="main-grid">
        <!-- Left Column: Results -->
        <div>
            <!-- Diagnosis Result -->
            {% if diagnosis.status == 'COMPLETED' or diagnosis.status == 'VALIDATED' %}
            <div class="result-section">
                <div class="section-header">
                    <h2 class="section-title">ü§ñ Resultado del Diagn√≥stico</h2>
                </div>
                
                <!-- Confidence Meter -->
                {% if diagnosis.confidence_level %}
                <div class="confidence-meter">
                    <div class="confidence-circle">
                        <svg width="150" height="150" viewBox="0 0 150 150">
                            <circle cx="75" cy="75" r="65" fill="none" stroke="var(--surface-light)" stroke-width="10"/>
                            <circle cx="75" cy="75" r="65" fill="none" stroke="var(--primary-color)" stroke-width="10"
                                    stroke-dasharray="{{ diagnosis.confidence_level|floatformat:0|add:'%' }} 408.4"
                                    stroke-linecap="round"
                                    transform="rotate(-90 75 75)"
                                    style="transition: stroke-dasharray 1s ease;"/>
                        </svg>
                        <div class="confidence-value">{{ diagnosis.confidence_level|floatformat:1 }}%</div>
                    </div>
                    <div class="confidence-label">Nivel de Confianza</div>
                </div>
                {% endif %}
                
                <!-- Diagnosis Text -->
                <div class="diagnosis-result">
                    <p class="diagnosis-text">{{ diagnosis.diagnosis_result }}</p>
                </div>
                
                <!-- AI Observations -->
                {% if diagnosis.ai_observations %}
                <div class="section-header" style="margin-top: 2rem;">
                    <h3 class="section-title">üí° Observaciones de la IA</h3>
                </div>
                <ul class="observations-list">
                    {% for observation in diagnosis.ai_observations %}
                    <li class="observation-item">
                        <span class="observation-icon">‚Ä¢</span>
                        <span class="observation-text">{{ observation }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            
            {% elif diagnosis.status == 'FAILED' %}
            <!-- Error State -->
            <div class="result-section">
                <div class="section-header">
                    <h2 class="section-title">‚ùå Error en el Procesamiento</h2>
                </div>
                <div style="text-align: center; padding: 3rem 2rem; color: var(--text-secondary);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <h3>No se pudo generar el diagn√≥stico</h3>
                    {% if diagnosis.error_message %}
                    <p style="margin-top: 1rem;">{{ diagnosis.error_message }}</p>
                    {% endif %}
                    <button class="btn btn-primary" style="margin-top: 1.5rem;" onclick="location.reload()">
                        üîÑ Reintentar
                    </button>
                </div>
            </div>
            {% endif %}
            
            <!-- Doctor Comments -->
            {% if diagnosis.status == 'COMPLETED' or diagnosis.status == 'VALIDATED' %}
            <div class="comments-section">
                <div class="section-header">
                    <h2 class="section-title">üí¨ Comentarios del M√©dico</h2>
                </div>
                
                {% if diagnosis.doctor_comments %}
                <div class="existing-comments">
                    <div class="comment-header">
                        <span class="comment-author">
                            üë®‚Äç‚öïÔ∏è {{ diagnosis.validated_by.get_full_name|default:diagnosis.requested_by.get_full_name }}
                        </span>
                        {% if diagnosis.validated_at %}
                        <span class="comment-date">{{ diagnosis.validated_at|date:"d/m/Y H:i" }}</span>
                        {% endif %}
                    </div>
                    <p class="comment-text">{{ diagnosis.doctor_comments }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Right Column: Metadata & Actions -->
        <div>
            <!-- Metadata -->
            <div class="metadata-section">
                <div class="section-header">
                    <h3 class="section-title">üìã Informaci√≥n</h3>
                </div>
                
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <span class="metadata-label">Solicitado por</span>
                        <span class="metadata-value">
                            üë®‚Äç‚öïÔ∏è {{ diagnosis.requested_by.get_full_name }}
                        </span>
                    </div>
                    
                    <div class="metadata-item">
                        <span class="metadata-label">Fecha Creaci√≥n</span>
                        <span class="metadata-value">{{ diagnosis.created_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    
                    {% if diagnosis.completed_at %}
                    <div class="metadata-item">
                        <span class="metadata-label">Fecha Completado</span>
                        <span class="metadata-value">{{ diagnosis.completed_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                    
                    {% if diagnosis.processing_time %}
                    <div class="metadata-item">
                        <span class="metadata-label">Tiempo Procesamiento</span>
                        <span class="metadata-value">{{ diagnosis.processing_time|floatformat:2 }} segundos</span>
                    </div>
                    {% endif %}
                    
                    {% if diagnosis.model_version %}
                    <div class="metadata-item">
                        <span class="metadata-label">Versi√≥n del Modelo</span>
                        <span class="metadata-value">{{ diagnosis.model_version }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="metadata-item">
                        <span class="metadata-label">Im√°genes Analizadas</span>
                        <span class="metadata-value">{{ images.count }} imagen{% if images.count != 1 %}es{% endif %}</span>
                    </div>
                </div>
                
                <!-- Images -->
                <div class="images-grid">
                    {% for image in images %}
                    <div class="image-card">
                        <div class="image-icon">
                            {% if image.study_type == 'RX' %}ü©ª
                            {% elif image.study_type == 'TAC' %}üî¨
                            {% elif image.study_type == 'RMN' %}üß≤
                            {% elif image.study_type == 'ECO' %}üì°
                            {% elif image.study_type == 'MAM' %}üéóÔ∏è
                            {% else %}üìã
                            {% endif %}
                        </div>
                        <div class="image-type">{{ image.get_study_type_display|default:image.study_type }}</div>
                        <div class="image-date">{{ image.study_date|date:"d/m/Y" }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Actions -->
            {% if diagnosis.status == 'COMPLETED' %}
            <div class="actions-section">
                <div class="section-header">
                    <h3 class="section-title">‚ö° Acciones</h3>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" style="width: 100%;" onclick="validateDiagnosis({{ diagnosis.id }})">
                        ‚úì Validar Diagn√≥stico
                    </button>
                    <button class="btn btn-outline" style="width: 100%;" onclick="exportDiagnosisPDF({{ diagnosis.id }})">
                        üì• Exportar PDF
                    </button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="discardDiagnosis({{ diagnosis.id }})">
                        üóëÔ∏è Descartar
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Audit Logs -->
    {% if logs %}
    <div class="logs-section">
        <div class="section-header">
            <h2 class="section-title">üìú Historial de Cambios</h2>
        </div>
        
        <div class="logs-timeline">
            {% for log in logs %}
            <div class="log-item">
                <div class="log-icon">
                    {% if log.action == 'CREATED' %}‚ûï
                    {% elif log.action == 'PROCESSING' %}‚öôÔ∏è
                    {% elif log.action == 'COMPLETED' %}‚úÖ
                    {% elif log.action == 'FAILED' %}‚ùå
                    {% elif log.action == 'VALIDATED' %}‚úì
                    {% elif log.action == 'DISCARDED' %}üóëÔ∏è
                    {% elif log.action == 'COMMENTED' %}üí¨
                    {% else %}üìù
                    {% endif %}
                </div>
                <div class="log-content">
                    <div class="log-action">{{ log.get_action_display }}</div>
                    {% if log.performed_by %}
                    <div class="log-details">
                        Por: {{ log.performed_by.get_full_name }}
                    </div>
                    {% endif %}
                    <div class="log-timestamp">{{ log.timestamp|date:"d/m/Y H:i:s" }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>


<script src="{% static 'diagnostico/js/diagnosis_detail.js' %}"></script>
<script>
    // Refuerzo: definir la funci√≥n en el scope global
    window.exportDiagnosisPDF = function(diagnosisId) {
        window.open(`/diagnostico/export-pdf/${diagnosisId}/`, '_blank');
    };
</script>

{% if diagnosis.status == 'PENDING' or diagnosis.status == 'PROCESSING' %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ya se agrega data-diagnosis-id en el div principal
    });
</script>
{% endif %}
{% endblock %}
