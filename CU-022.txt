@startuml
actor "Administrador" as admin
participant "Interfaz\nPermisos" as interfaz
participant "Controlador\nPermisos" as controlador
participant "Base de Datos\nRoles" as bd_roles
participant "Base de Datos\nPermisos" as bd_permisos
participant "Base de Datos\nAuditoría" as bd_audit

== Acceso al Módulo ==
admin -> interfaz : Accede al módulo "Permisos de Acceso"
activate interfaz
interfaz -> controlador : verificarAccesoAdmin(idUsuario)
activate controlador
controlador -> bd_roles : verificarRolAdministrador(idUsuario)
activate bd_roles
bd_roles --> controlador : rolVerificado
deactivate bd_roles
controlador --> interfaz : accesoPermitido
deactivate controlador

== Visualización de Roles ==
interfaz -> controlador : obtenerRolesExistentes()
activate controlador
controlador -> bd_roles : consultarRoles()
activate bd_roles
bd_roles --> controlador : listaRoles(Administrador, Médico, Técnico)
deactivate bd_roles
controlador --> interfaz : mostrarRoles()
deactivate controlador
interfaz --> admin : Muestra roles existentes
deactivate interfaz

note right of admin
    Roles del sistema:
    - Administrador
    - Médico Radiólogo
    - Técnico de Salud
end note

== Selección de Rol ==
admin -> interfaz : Selecciona un rol para modificar permisos
activate interfaz
interfaz -> controlador : cargarPermisosRol(idRol)
activate controlador
controlador -> bd_permisos : obtenerPermisosActuales(idRol)
activate bd_permisos
bd_permisos --> controlador : listaPermisosActuales(modulo, accion, estado)
deactivate bd_permisos
controlador --> interfaz : mostrarPermisosActuales()
deactivate controlador
interfaz --> admin : Muestra permisos asignados al rol
deactivate interfaz

note right of interfaz
    Permisos por módulo:
    - Gestión de Imágenes (ver/cargar/editar)
    - Diagnóstico IA (solicitar/revisar/finalizar)
    - Historial (consultar/exportar)
    - Administración (gestionar usuarios/reportes)
end note

== Modificación de Permisos ==
admin -> interfaz : Modifica permisos (activa/desactiva acciones)
activate interfaz
admin -> interfaz : Guarda cambios
interfaz -> controlador : actualizarPermisos(idRol, permisosModificados)
activate controlador

' Validar cambios
controlador -> controlador : validarIntegridadPermisos()

alt Validación exitosa
    controlador -> bd_permisos : actualizarPermisosRol(idRol, nuevosPermisos)
    activate bd_permisos
    
    alt Actualización exitosa
        bd_permisos --> controlador : permisosActualizados
        deactivate bd_permisos
        
        ' Invalidar sesiones activas del rol (opcional)
        controlador -> controlador : invalidarSesionesRol(idRol)
        
        ' Registrar en auditoría
        controlador -> bd_audit : registrarCambioPermisos(idAdmin, idRol, cambios, timestamp)
        activate bd_audit
        bd_audit --> controlador : registroOK
        deactivate bd_audit
        
        controlador --> interfaz : permisosActualizadosExitosamente()
        deactivate controlador
        interfaz --> admin : "Permisos actualizados correctamente"
        deactivate interfaz
        
        note right of admin
            Los cambios se aplican:
            - Inmediatamente para nuevas sesiones
            - Tras cerrar sesión para usuarios activos
        end note
        
    else Error en guardado (A1)
        bd_permisos --> controlador : errorActualizacion
        deactivate bd_permisos
        controlador --> interfaz : errorAlActualizar()
        deactivate controlador
        interfaz --> admin : "No fue posible actualizar los permisos"
        deactivate interfaz
    end
    
else Permisos inválidos
    controlador --> interfaz : permisosInvalidos()
    deactivate controlador
    interfaz --> admin : "Configuración de permisos inválida.\nVerifique las dependencias"
    deactivate interfaz
end

== Visualización de Cambios ==
admin -> interfaz : Solicita ver resumen de cambios
activate interfaz
interfaz -> controlador : obtenerHistorialCambios(idRol)
activate controlador
controlador -> bd_audit : consultarCambiosPermisos(idRol, fechaInicio, fechaFin)
activate bd_audit
bd_audit --> controlador : historialCambios
deactivate bd_audit
controlador --> interfaz : mostrarHistorial()
deactivate controlador
interfaz --> admin : Muestra historial de modificaciones
deactivate interfaz

@enduml
