@startuml
actor "Médico Radiólogo" as medico
participant "Interfaz\nHistorial" as interfaz
participant "Controlador\nHistorial" as controlador
participant "Base de Datos\nPacientes" as bd_pac
participant "Base de Datos\nDiagnósticos" as bd_diag

== Acceso al Módulo ==
medico -> interfaz : Accede al módulo "Historial de Diagnósticos"
activate interfaz
interfaz -> controlador : verificarAcceso(idMedico)
activate controlador
controlador -> bd_pac : verificarPermisos(idMedico)
activate bd_pac
bd_pac --> controlador : permisosOK
deactivate bd_pac
controlador --> interfaz : moduloDisponible
deactivate controlador
interfaz --> medico : Muestra formulario de búsqueda
deactivate interfaz

== Búsqueda de Paciente ==
medico -> interfaz : Ingresa nombre o ID del paciente
activate interfaz
medico -> interfaz : Solicita búsqueda
interfaz -> controlador : buscarPaciente(criterioBusqueda)
activate controlador
controlador -> bd_pac : consultarPaciente(nombre_o_ID)
activate bd_pac

alt Paciente encontrado
    bd_pac --> controlador : datosPaciente
    deactivate bd_pac
    
    ' Buscar diagnósticos asociados
    controlador -> bd_diag : obtenerDiagnosticosHistorial(idPaciente)
    activate bd_diag
    
    alt Existen diagnósticos previos
        bd_diag --> controlador : listaDiagnosticos(fecha, tipo, resultado)
        deactivate bd_diag
        controlador --> interfaz : mostrarHistorial(diagnosticos)
        deactivate controlador
        interfaz --> medico : Muestra lista de diagnósticos anteriores
        deactivate interfaz
        
        == Visualización de Detalles ==
        medico -> interfaz : Selecciona un diagnóstico para ver detalles
        activate interfaz
        interfaz -> controlador : obtenerDetallesDiagnostico(idDiagnostico)
        activate controlador
        controlador -> bd_diag : consultarDiagnosticoCompleto(idDiagnostico)
        activate bd_diag
        bd_diag --> controlador : detallesCompletos
        deactivate bd_diag
        controlador --> interfaz : presentarDetalles()
        deactivate controlador
        interfaz --> medico : Muestra información detallada del diagnóstico
        deactivate interfaz
        
    else Sin diagnósticos previos (A1)
        bd_diag --> controlador : listaDiagnosticosVacia
        deactivate bd_diag
        controlador --> interfaz : sinDiagnosticos()
        deactivate controlador
        interfaz --> medico : "No existen diagnósticos registrados\npara este paciente"
        deactivate interfaz
    end
    
else Paciente no encontrado
    bd_pac --> controlador : pacienteNoEncontrado
    deactivate bd_pac
    controlador --> interfaz : sinResultados()
    deactivate controlador
    interfaz --> medico : "No se encontró el paciente"
    deactivate interfaz
end

== Flujo Alternativo: Error de Conexión (A2) ==
alt Error de conexión
    medico -> interfaz : Solicita búsqueda
    activate interfaz
    interfaz -> controlador : buscarPaciente(criterioBusqueda)
    activate controlador
    controlador -> bd_diag : obtenerDiagnosticosHistorial(idPaciente)
    activate bd_diag
    bd_diag --> controlador : errorConexion
    deactivate bd_diag
    controlador --> interfaz : errorAlCargar()
    deactivate controlador
    interfaz --> medico : "No se pudieron cargar los datos.\nIntente más tarde"
    deactivate interfaz
end

@enduml