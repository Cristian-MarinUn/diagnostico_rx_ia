@startuml
actor "Administrador" as admin
participant "Interfaz\nGestión Usuarios" as interfaz
participant "Controlador\nUsuarios" as controlador
participant "Base de Datos\nUsuarios" as bd_users
participant "Base de Datos\nAuditoría" as bd_audit

== Acceso al Módulo ==
admin -> interfaz : Accede al módulo "Gestión de Usuarios"
activate interfaz
interfaz -> controlador : verificarAccesoAdmin(idUsuario)
activate controlador
controlador -> bd_users : verificarRolAdministrador(idUsuario)
activate bd_users
bd_users --> controlador : rolVerificado
deactivate bd_users
controlador --> interfaz : accesoPermitido
deactivate controlador

== Listado de Usuarios ==
interfaz -> controlador : obtenerListaUsuarios()
activate controlador
controlador -> bd_users : consultarTodosUsuarios()
activate bd_users
bd_users --> controlador : listaUsuarios(nombre, rol, estado, fechaRegistro)
deactivate bd_users
controlador --> interfaz : mostrarListaUsuarios()
deactivate controlador
interfaz --> admin : Muestra lista de usuarios registrados
deactivate interfaz

note right of admin
    Opciones disponibles:
    - Crear nuevo usuario
    - Editar usuario existente
    - Desactivar usuario
end note

== Flujo: Crear Usuario ==
admin -> interfaz : Selecciona "Crear nuevo usuario"
activate interfaz
interfaz -> controlador : iniciarCreacionUsuario()
activate controlador
controlador --> interfaz : mostrarFormulario()
deactivate controlador
interfaz --> admin : Muestra formulario de creación
deactivate interfaz

admin -> interfaz : Ingresa datos del nuevo usuario
activate interfaz
admin -> interfaz : Confirma creación
interfaz -> controlador : crearUsuario(datosUsuario)
activate controlador

' Validaciones
controlador -> controlador : validarDatosCompletos()
controlador -> bd_users : verificarCorreoUnico(email)
activate bd_users

alt Correo disponible y datos válidos
    bd_users --> controlador : correoDisponible
    deactivate bd_users
    
    controlador -> bd_users : insertarNuevoUsuario(datos)
    activate bd_users
    bd_users --> controlador : usuarioCreado(idUsuario)
    deactivate bd_users
    
    controlador -> bd_audit : registrarAccion(idAdmin, "crear_usuario", timestamp)
    activate bd_audit
    bd_audit --> controlador : registroOK
    deactivate bd_audit
    
    controlador --> interfaz : usuarioCreadoExitosamente()
    deactivate controlador
    interfaz --> admin : "Usuario creado exitosamente"
    deactivate interfaz
    
else Correo ya registrado
    bd_users --> controlador : correoExistente
    deactivate bd_users
    controlador --> interfaz : errorCorreoDuplicado()
    deactivate controlador
    interfaz --> admin : "El correo ya está registrado"
    deactivate interfaz
end

== Flujo: Editar Usuario ==
admin -> interfaz : Selecciona usuario y "Editar"
activate interfaz
interfaz -> controlador : cargarDatosUsuario(idUsuario)
activate controlador
controlador -> bd_users : obtenerUsuario(idUsuario)
activate bd_users
bd_users --> controlador : datosUsuario
deactivate bd_users
controlador --> interfaz : mostrarFormularioEdicion(datos)
deactivate controlador
interfaz --> admin : Muestra datos editables
deactivate interfaz

admin -> interfaz : Realiza cambios y guarda
activate interfaz
interfaz -> controlador : actualizarUsuario(idUsuario, datosModificados)
activate controlador

alt Usuario encontrado
    controlador -> bd_users : actualizarDatosUsuario(idUsuario, datos)
    activate bd_users
    bd_users --> controlador : usuarioActualizado
    deactivate bd_users
    
    controlador -> bd_audit : registrarAccion(idAdmin, "editar_usuario", timestamp)
    activate bd_audit
    bd_audit --> controlador : registroOK
    deactivate bd_audit
    
    controlador --> interfaz : cambiosGuardados()
    deactivate controlador
    interfaz --> admin : "Cambios aplicados correctamente"
    deactivate interfaz
    
else Usuario no encontrado (A1)
    bd_users --> controlador : usuarioNoEncontrado
    controlador --> interfaz : errorUsuarioNoExiste()
    deactivate controlador
    interfaz --> admin : "Usuario no encontrado"
    deactivate interfaz
end

== Flujo: Desactivar Usuario ==
admin -> interfaz : Selecciona usuario y "Desactivar"
activate interfaz
interfaz -> controlador : desactivarUsuario(idUsuario)
activate controlador
controlador -> bd_users : cambiarEstado(idUsuario, "inactivo")
activate bd_users
bd_users --> controlador : estadoActualizado
deactivate bd_users

controlador -> bd_audit : registrarAccion(idAdmin, "desactivar_usuario", timestamp)
activate bd_audit
bd_audit --> controlador : registroOK
deactivate bd_audit

controlador --> interfaz : usuarioDesactivado()
deactivate controlador
interfaz --> admin : "Usuario desactivado correctamente"
deactivate interfaz

@enduml